# 意图识别与 Planner 流程示例

> 本文用 **多个完整例子**，按「用户输入 → 意图识别（需求分析）→ Planner（规划）→ 下游执行」的顺序，说明意图识别和 Planner **分别做了哪些事**，以及中间产物的形态。  
> 对应架构见 [小红书助手.md](小红书助手.md)、技术选型见 [需求分析与Planner技术调研.md](需求分析与Planner技术调研.md)。

---

## 示例一：流行选题 → 特色图文 → 用户可调整 → 发布小红书（工装企业）

**场景**：根据行业流行的小红书文章生成选题，再生成带企业特色的图文内容；用户若觉得有问题可继续调整，没问题则发布到小红书。

### 1. 输入：客户配置与用户指令

#### 1.1 客户配置（两种模式）

| 模式 | 输入方式 | 内容 |
| --- | --- | --- |
| **模式 1（语言输入）** | 用户用自然语言描述企业与品牌 | 「我是做工装的，我的品牌是"全包圆装修"，我的优势是性价比高，服务的客户多。」 |
| **模式 2（链接理解）** | 用户提供官网/落地页链接，系统进行理解 | `https://www.quanbaoyuan.cn/`（可抓取或解析页面内容，提炼品牌、业务、卖点等） |

#### 1.2 用户长短期记忆（账号上下文）

- **标签**：行业标签、内容标签、用户画像标签等  
- **背景**：账号人设、品牌、行业、阶段（冷启动/放量/变现）  
- **最近交互标签**：近期对话或操作涉及的主题、意图  
- **爱好 / 偏好**：内容风格、发布节奏等  
- **数据表现**：历史笔记的互动、完读、转化等  
- **客户运营等级**（若有）：用于权益、推荐策略或优先级  

以上在意图识别与 Planner 阶段可作为**账号上下文**注入，供槽位补全与规划使用。

#### 1.3 用户指令（本条请求）

- **原始输入**：「我是做工装行业的企业，帮我根据当前我们行业比较流行的一些小红书文章，生成一个选题，然后生成一个我自己特色的图文内容，我将把这个图文内容发布到小红书里去。」

#### 1.4 需求意图理解阶段的用户参与

- **可由用户对任务拆解过程进行修改**：在意图识别或 Planner 产出「任务拆解 / 计划」后，将拆解结果（如意图类型、槽位、或计划步骤）展示给用户；用户可**增删步骤、调整顺序、修改槽位或验收标准**，再进入执行。下文的意图输出与 Planner 输出即「可被用户修改」的中间产物。

---

### 2. 意图识别（需求分析）模块做的所有事情

| 步骤 | 模块在做的事 | 输入 | 输出/中间产物 |
| --- | --- | --- | --- |
| **2.1 意图分类** | 判断属于「选题策划 + 内容生成 + 发布目标」的链式意图；与五类 Agent 对齐 | 用户指令 + 可选客户配置（模式1/2） | 意图类型：`topic_planning`（选题策划）+ `content_generation`（内容生成）；目标：发布到小红书；单任务链 |
| **2.2 OOS 检测** | 判断是否在预定义意图边界内 | 用户指令 + 意图边界配置 | 在范围内，非 OOS |
| **2.3 槽位抽取** | 从指令与客户配置中抽取：行业、品牌、优势、参考来源（流行文章）、内容形式（图文）、发布目标 | 用户指令 + 模式1 文案（或模式2 链接解析结果）+ Slot Schema | `slots`: `industry=工装`, `brand=全包圆装修`, `advantages=性价比高、服务客户多`, `content_reference=行业流行小红书文章`, `content_form=图文`, `publish_target=小红书` |
| **2.4 融合账号上下文** | 将长短期记忆（标签、背景、最近交互、数据表现、运营等级）与 slots 融合；缺省槽位用记忆补全 | slots + 用户记忆/账号上下文 | 例如补全 `persona`、`account_stage`、历史偏好等，供 Planner 使用 |
| **2.5 必填槽位检查** | 检查选题+图文+发布链路的必填槽是否齐全 | 意图类型 + slots + 账号上下文 | 本例在配置与指令下基本齐全；若有缺则 `needs_clarification=true` 与 `clarification_question` |
| **2.6 输出结构化结果（可被用户修改）** | 汇总为 Planner 与下游可消费的 JSON；该结果可先展示给用户，支持对意图/槽位/拆解的修改 | 以上全部 | 见下方「意图模块最终输出」 |

**意图模块最终输出（示例）：**

```json
{
  "demand_summary": "工装行业企业（品牌：全包圆装修，优势：性价比高、服务客户多），希望基于当前行业流行的小红书文章生成一个选题，再生成具有自身特色的图文内容，并发布到小红书。",
  "intent_type": "chained",
  "intent_breakdown": ["topic_planning", "content_generation"],
  "slots": {
    "industry": "工装",
    "brand": "全包圆装修",
    "advantages": ["性价比高", "服务的客户多"],
    "content_reference": "行业流行小红书文章",
    "content_form": "图文",
    "publish_target": "小红书",
    "persona_source": "mode1_language",
    "brand_link": "https://www.quanbaoyuan.cn/"
  },
  "needs_clarification": false,
  "suggested_agents": ["选题策划", "内容生成", "内容评估与检验"],
  "user_can_edit_task_breakdown": true
}
```

（若启用模式 2，可增加从链接解析出的 `brand_summary`、`service_highlights` 等字段，一并写入 slots 或单独上下文。）

---

### 3. Planner 做的所有事情

| 步骤 | Planner 在做的事 | 输入 | 输出/中间产物 |
| --- | --- | --- | --- |
| **3.1 接收意图输出 + 账号上下文** | 读取意图的 `demand_summary`、`intent_type`、`slots`；读取客户配置（模式1/2 内容）、用户记忆（标签、背景、数据表现、运营等级） | 意图 JSON + 账号上下文 + 品牌/链接解析结果 | 规划所需的完整输入 |
| **3.2 生成多步计划** | 按「流行选题 → 特色图文 → 评估 → 待发布」生成步骤；每步写明输入摘要与验收条件 | 上述输入 | `steps[]`：选题策划 → 内容生成 → 内容评估与检验；发布在用户确认无问题后执行 |
| **3.3 条件分支** | 不包含「投流」；包含「用户确认」：评估通过后产出物先给用户，用户可调整再重新走生成/评估或直接发布 | 意图 + slots + 产品策略 | 计划中 s3 之后为「用户确认」；若用户修改任务拆解，则重新生成 plan |
| **3.4 输出计划（可被用户修改）** | 将计划写入状态机；若产品支持「用户对任务拆解进行修改」，则本计划先展示给用户，用户可改步骤/顺序/验收标准后再执行 | 无 | 见下方「Planner 最终输出」 |

**Planner 最终输出（示例）：**

```json
{
  "plan": {
    "steps": [
      {
        "step_id": "s1",
        "agent": "选题策划",
        "input_summary": "基于工装行业、品牌全包圆装修及优势（性价比高、服务客户多），结合当前行业流行的小红书文章，做热门话题捕捉与选题价值评估；输出 1 个高优先级选题及执行建议（结构/风格）。",
        "depends_on": [],
        "acceptance_criteria": "选题与工装、装修场景匹配，且可体现品牌特色与性价比/服务优势。"
      },
      {
        "step_id": "s2",
        "agent": "内容生成",
        "input_summary": "基于 s1 选题与账号人设（全包圆装修、工装、性价比与服务优势），生成一篇具有企业特色的图文笔记：正文结构驱动、人设语气、图文协同、平台敏感词规避。",
        "depends_on": ["s1"],
        "acceptance_criteria": "正文与配图规划完整，体现品牌与优势，符合小红书规范。"
      },
      {
        "step_id": "s3",
        "agent": "内容评估与检验",
        "input_summary": "对生成的图文内容做质量、人设一致性、合规、AI 痕迹、发布前评分与修改建议。",
        "depends_on": ["s2"],
        "acceptance_criteria": "评分达标且无合规风险；若有问题则输出可执行修改建议。"
      }
    ],
    "after_s3": "将图文内容呈现给用户；用户若有问题可继续调整（回到 s2 或 s1），若无问题则执行发布到小红书。",
    "user_can_edit_plan": true
  }
}
```

---

### 4. 下游实际发生的事（简述）

- **执行层**：按 `s1 → s2 → s3` 顺序执行选题策划、内容生成、内容评估与检验。
- **用户确认与调整**：s3 通过后，将生成的图文内容（含正文、配图规划、标签建议等）交给用户；**用户觉得有问题**则可继续调整（例如修改选题、重生成正文或配图），可重新进入 s1/s2 或仅重跑 s2；**用户觉得没问题**则执行「发布到小红书」。
- **发布**：发布动作可为单独步骤或由用户在前端触发，使用小红书开放能力或托管投放相关接口（见 [技术调研.md](技术调研.md) 平台适配）。

---

## 示例二：混合意图 ——「起个美妆账号，先做种草，一周 3 更」

### 1. 用户输入

- **原始输入**：「帮我起个美妆账号，先做种草，一周 3 更。」

### 2. 意图识别（需求分析）模块做的所有事情

| 步骤 | 模块在做的事 | 输入 | 输出/中间产物 |
| --- | --- | --- | --- |
| **2.1 意图分类** | 判断这句话属于哪一类（或哪几类）意图，与五类 Agent 能力对齐 | 用户原文 | 意图类型：`account_strategy`（账号战略）+ `content_direction`（内容方向/种草）+ `rhythm_constraint`（更新节奏）；多意图/混合任务 |
| **2.2 OOS 检测** | 判断是否在预定义意图边界内；若为闲聊、无关、无法服务则拒识或转人工 | 用户原文 + 意图边界配置 | 结论：在范围内，非 OOS |
| **2.3 槽位抽取** | 从文本中抽出业务参数，填入结构化槽位 | 用户原文 + 当前意图对应的 Slot Schema | `slots`: `industry=美妆`, `goal=种草`, `update_frequency=一周3更`, `account_stage=起号`（隐含）, `content_type=种草向内容`（隐含） |
| **2.4 必填槽位检查** | 检查当前意图所需必填槽是否齐全；若缺或歧义则生成澄清问句 | 意图类型 + slots + 必填配置 | 本例必填基本齐全；若有缺（如未指定行业）则输出 `needs_clarification=true` 与 `clarification_question` |
| **2.5 意图泛化 / RAG（可选）** | 用「意图泛化知识库」或历史相似问法做检索，辅助最终意图与槽位 | 用户原文 + 知识库/历史 session | 召回类似「起号、美妆、种草」的 Case，用于 few-shot 或置信度校准 |
| **2.6 输出结构化结果** | 汇总为 Planner 与下游可消费的 JSON | 以上全部 | 见下方「意图模块最终输出」 |

**意图模块最终输出（示例）：**

```json
{
  "demand_summary": "用户希望从零搭建美妆账号，以种草为目标，更新节奏为一周 3 更。",
  "intent_type": "mixed",
  "intent_breakdown": [
    "account_strategy",
    "content_direction",
    "rhythm_constraint"
  ],
  "slots": {
    "industry": "美妆",
    "goal": "种草",
    "update_frequency": "一周3更",
    "account_stage": "起号",
    "content_focus": "种草向内容"
  },
  "needs_clarification": false,
  "suggested_agents": ["账号战略", "选题策划", "内容生成", "内容评估与检验"]
}
```

### 3. Planner 做的所有事情

| 步骤 | Planner 在做的事 | 输入 | 输出/中间产物 |
| --- | --- | --- | --- |
| **3.1 接收意图输出 + 账号上下文** | 读取意图模块的 `demand_summary`、`intent_type`、`slots`；读取当前账号的人设、阶段、历史摘要（若为新账号则为空或默认） | 意图 JSON + 账号上下文（人设、阶段、目标、历史内容摘要） | 规划所需的完整输入 |
| **3.2 生成多步计划** | 根据「要达成用户需求」反推需要调用哪些 Agent、顺序与依赖；每步写出输入摘要与验收条件 | 上述输入 | 结构化 `steps[]`，每步含 `step_id`、`agent`、`input_summary`、`depends_on`、`acceptance_criteria` |
| **3.3 条件分支** | 判断是否需要投流、是否需要多轮选题等；决定步骤集合与分支 | 意图 + slots（如 goal=种草 可能暂不投流） | 本例：不包含投流步骤；若用户后续说「再帮我投一下」则可在新请求中单独规划投流 |
| **3.4 输出计划并交给运行时** | 将计划写入 LangGraph 状态（如 `plan`、`past_steps`）；由状态机按序执行各步骤，执行完一步可进入 Replan 或继续下一步 | 无（输出即下游输入） | 见下方「Planner 最终输出」 |

**Planner 最终输出（示例）：**

```json
{
  "plan": {
    "steps": [
      {
        "step_id": "s1",
        "agent": "账号战略",
        "input_summary": "基于行业=美妆、目标=种草、更新节奏=一周3更，输出账号定位、人设（3句话）、内容结构配比、阶段策略与禁忌。",
        "depends_on": [],
        "acceptance_criteria": "产出人设与策略文档，且与美妆种草场景一致。"
      },
      {
        "step_id": "s2",
        "agent": "选题策划",
        "input_summary": "结合账号战略产出与阶段=起号，做热门话题捕捉、选题池扩展与选题价值评估；输出 5～10 个高优先级选题及执行建议。",
        "depends_on": ["s1"],
        "acceptance_criteria": "选题列表与美妆种草、起号阶段匹配；含结构/风格建议。"
      },
      {
        "step_id": "s3",
        "agent": "内容生成",
        "input_summary": "针对选题策划给出的高优先级选题，按人设与结构生成首篇笔记正文与配图规划（结构驱动、人设语气、平台敏感词规避）。",
        "depends_on": ["s2"],
        "acceptance_criteria": "正文+配图规划完整，符合人设与平台规范。"
      },
      {
        "step_id": "s4",
        "agent": "内容评估与检验",
        "input_summary": "对生成内容做质量、人设一致性、合规、AI 痕迹、发布前评分与修改建议。",
        "depends_on": ["s3"],
        "acceptance_criteria": "评分达标且无合规风险；若有问题则输出可执行修改建议。"
      }
    ]
  }
}
```

### 4. 下游实际发生的事（简述）

- **执行层**（LangGraph 的 execute 节点）：按 `s1 → s2 → s3 → s4` 顺序调用对应 Agent；每步的 `input_summary` 与 `depends_on` 的上一级产出一起，作为该 Agent 的输入。
- **Verifier**：在 s4（内容评估与检验）之后根据 `acceptance_criteria` 判断通过与否；若不通过，将原因写回状态并进入 **Replan**，由 Planner 更新计划（例如增加「内容生成」重试或修改步骤）。
- **Generator**：若通过，将 s3 的正文与配图规划等汇总为可发布的「笔记+标签+评论引导」等最终产物。

---

## 示例三：单意图 ——「给上一篇笔记生成 3 个爆款标题，我要 A/B 测试」

### 1. 用户输入

- **原始输入**：「给上一篇笔记生成 3 个爆款标题，我要 A/B 测试。」

### 2. 意图识别（需求分析）模块做的所有事情

| 步骤 | 模块在做的事 | 输入 | 输出/中间产物 |
| --- | --- | --- | --- |
| **2.1 意图分类** | 判断属于选题策划下的「爆款标题生成」，且明确数量与用途 | 用户原文 | 意图类型：`topic_planning`（选题策划），子类型：`burst_title_generation`；单意图 |
| **2.2 OOS 检测** | 判断是否在预定义意图边界内 | 用户原文 | 在范围内，非 OOS |
| **2.3 槽位抽取** | 抽取「上一篇笔记」「3 个」「A/B 测试」等参数 | 用户原文 + Slot Schema | `slots`: `reference=上一篇笔记`, `title_count=3`, `usage=A/B测试` |
| **2.4 必填槽位检查** | 「上一篇笔记」依赖上下文（当前账号下最近一篇）；若系统能解析则不必澄清 | 意图 + slots + 上下文（当前账号最近笔记 ID/摘要） | 若上下文存在则不需澄清；若无「上一篇」则 `needs_clarification=true`，问「请指定要基于哪篇笔记生成标题？」 |
| **2.5 输出结构化结果** | 汇总为 Planner 可消费的 JSON | 以上 | 见下方 |

**意图模块最终输出（示例）：**

```json
{
  "demand_summary": "基于上一篇笔记生成 3 个爆款标题，用于 A/B 测试。",
  "intent_type": "topic_planning",
  "intent_breakdown": ["burst_title_generation"],
  "slots": {
    "reference": "上一篇笔记",
    "title_count": 3,
    "usage": "A/B测试"
  },
  "needs_clarification": false,
  "suggested_agents": ["选题策划", "内容评估与检验"]
}
```

### 3. Planner 做的所有事情

| 步骤 | Planner 在做的事 | 输入 | 输出/中间产物 |
| --- | --- | --- | --- |
| **3.1 接收意图 + 账号上下文** | 读取意图输出；读取「上一篇笔记」对应的内容摘要/标题（由上下文服务解析） | 意图 JSON + 账号上下文（最近一篇笔记的 ID、标题、正文摘要） | 规划输入 |
| **3.2 生成多步计划** | 只需选题策划产出多个标题，可选内容评估做一次筛选或打分 | 上述输入 | 步骤较少：选题策划 → 可选内容评估 |
| **3.3 条件分支** | 用户明确要 A/B 测试，不需生成正文、不需投流；评估为可选（仅对标题做质量/人设一致性等简单校验） | 意图 + slots | 计划仅含 1～2 步 |
| **3.4 输出计划** | 写入状态机，由运行时执行 | 无 | 见下方 |

**Planner 最终输出（示例）：**

```json
{
  "plan": {
    "steps": [
      {
        "step_id": "s1",
        "agent": "选题策划",
        "input_summary": "基于上下文中的「上一篇笔记」内容与选题，生成 3 个爆款标题变体，适合 A/B 测试；保持风格与人设一致。",
        "depends_on": [],
        "acceptance_criteria": "输出恰好 3 个标题，且与上一篇笔记主题一致、可区分度适合 A/B 测试。"
      },
      {
        "step_id": "s2",
        "agent": "内容评估与检验",
        "input_summary": "对 3 个标题做人设一致性、平台合规与简短质量评估，给出优先级或修改建议（可选）。",
        "depends_on": ["s1"],
        "acceptance_criteria": "无合规风险；若有明显优劣可给出排序或建议。"
      }
    ]
  }
}
```

### 4. 下游实际发生的事（简述）

- **执行层**：先执行 s1（选题策划）—— 调用选题策划 Agent，输入为「上一篇笔记」的摘要 + 人设等，输出 3 个标题；再执行 s2（内容评估与检验）—— 对 3 个标题做轻量评估。
- **Verifier**：在 s2 后根据 `acceptance_criteria` 判断通过与否；通过则把 3 个标题返回用户用于 A/B 测试；不通过则 Replan（例如只重做 s1 或调整 s2 的评估标准）。

---

## 小结：意图识别 vs Planner 各负责什么

| 环节 | 意图识别（需求分析） | Planner（规划） |
| --- | --- | --- |
| **输入** | 用户自然语言（+ 可选多轮历史） | 意图模块的结构化输出 + 账号上下文 |
| **核心做的事** | 意图分类、OOS 拒识、槽位抽取、必填检查、**澄清问句**（缺槽/歧义时）、输出 demand_summary / intent_type / slots | 根据需求与上下文生成多步计划（步骤、Agent、依赖、验收条件）、做条件分支（是否投流、是否评估等） |
| **输出** | 结构化 JSON（demand_summary, intent_type, slots, needs_clarification 等） | 结构化 Plan（steps[]，每步 step_id / agent / input_summary / depends_on / acceptance_criteria） |
| **下游** | 输出直接作为 Planner 的输入；**若 needs_clarification 则为多轮澄清，不进入 Planner**（询问用户澄清需求的主环节在意图理解） | 输出驱动 LangGraph 状态机按序执行各 Agent；Verifier 不通过时触发 Replan |
| **询问用户澄清需求** | **主环节**：必填槽缺失或歧义时，本环节返回澄清问句，不进入 Planner | 否；执行中若某 Agent 发现信息不足可发起**执行期澄清**（辅环节）。详见 [需求分析与Planner技术调研](需求分析与Planner技术调研.md)「环节定义与任务目标」。 |

三个示例分别覆盖：**示例一**——流行选题 → 特色图文 → 用户可调整 → 发布小红书（工装企业，含客户配置模式1/2、长短期记忆、用户可修改任务拆解）；**示例二**——混合意图（起号+种草+节奏）；**示例三**——单意图（爆款标题生成）。均展示了意图识别与 Planner 在上述流程中**分别做的所有事情**及中间产物形态。
